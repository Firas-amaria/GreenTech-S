<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shipment Report | Farmer App</title>
  <style>
    /* ===== Reset & Base Styles ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    h1, h2, h3, h4 {
      color: #2b3e50;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    h2 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }
    h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      font-style: italic;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      background: #fff;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background-color: #2b3e50;
      color: #fff;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    input, select, textarea, button {
      font-size: 0.9rem;
      padding: 6px 8px;
    }
    textarea {
      resize: vertical;
    }
    button {
      cursor: pointer;
    }
    .btn-primary {
      background-color: #2b3e50;
      color: #fff;
      border: none;
    }
    .btn-primary:hover {
      background-color: #1a2733;
    }
    .btn-danger {
      background-color: #c0392b;
      color: #fff;
      border: none;
    }
    .btn-danger:hover {
      background-color: #922d21;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 200px;
      background-color: #2b3e50;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      flex-shrink: 0;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
      letter-spacing: 1px;
    }
    .sidebar ul {
      list-style: none;
      width: 100%;
    }
    .sidebar li {
      width: 100%;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .sidebar a:hover {
      background-color: #1a2733;
    }

    /* ===== Main Content ===== */
    .main {
      flex-grow: 1;
      background-color: #f4f7f9;
      overflow-y: auto;
      padding: 20px;
    }
    .section {
      margin-bottom: 2rem;
    }
    .inline-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .inline-row label {
      min-width: 120px;
    }
    .inline-row input,
    .inline-row select {
      flex-grow: 1;
    }
    .container-block {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 1rem;
      background: #fff;
    }
    .container-block h3 {
      margin-bottom: 0.75rem;
    }
    .param-select {
      width: 100%;
      max-width: 200px;
    }
  </style>
</head>
<body>
  <!-- ===== Sidebar ===== -->
  <nav class="sidebar">
    <h2>Farmer App</h2>
    <ul>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="crops.html">Crops</a></li>
      <li><a href="shipments.html">Shipments</a></li>
      <li><a href="#" id="logoutLink4">Logout</a></li>
    </ul>
  </nav>

  <!-- ===== Main Content ===== -->
  <div class="main">
    <h1>Shipment Report</h1>

    <!-- ===== Shipment Info ===== -->
    <div class="section" id="shipmentInfo">
      <h2>Shipment Details</h2>
      <div class="inline-row">
        <label>Shipment ID:</label>
        <span id="spanShipmentId">—</span>
      </div>
      <div class="inline-row">
        <label>Item:</label>
        <span id="spanItem">—</span>
      </div>
      <div class="inline-row">
        <label>Amount (kg):</label>
        <span id="spanAmount">—</span>
      </div>
      <div class="inline-row">
        <label>Pickup Time:</label>
        <span id="spanPickupTime">—</span>
      </div>
    </div>

    <!-- ===== Number of Containers ===== -->
    <div class="section" id="containerCountSection">
      <h2>Container Setup</h2>
      <div class="inline-row">
        <label for="inputContainerCount"># of Containers Received:</label>
        <input type="number" id="inputContainerCount" min="1" placeholder="e.g. 5" />
      </div>
      <button class="btn-primary" id="btnGenerateContainers">Generate Containers</button>
      <p style="font-size:0.9rem; color:#555; margin-top:4px;">
        <!-- In a real app, scanning would fill the barcode. For now, we use codes "001", "002", etc. -->
      </p>
    </div>

    <!-- ===== Container Blocks (dynamically injected) ===== -->
    <div id="containersContainer" class="section"></div>

    <!-- ===== Submit Button ===== -->
    <div class="submit-row">
      <button class="btn-primary" id="btnSubmitReport">Submit Shipment Report</button>
    </div>
  </div>

  <script>
    /*******************************************************
     * In‐Memory Sample Data for Shipment (replace with real API later)
     *******************************************************/
    const sampleShipments = [
      { id: 301, item: 'Tomato', amount: 120, pickupTime: '2025-06-02T08:00' },
      { id: 302, item: 'Lettuce', amount: 80, pickupTime: '2025-06-01T09:30' },
      { id: 303, item: 'Potato', amount: 200, pickupTime: '2025-06-04T11:00' }
    ];

    const cropStatusOptions = [
      "Planting",
      "Growing",
      "Crop Maintenance",
      "Blooming",
      "Fruit Set",
      "Ripening",
      "Harvesting",
      "Harvested",
      "Field Clearing"
    ];

    // ===== Parse query param "shipmentId" =====
    function getQueryParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    const shipmentId = getQueryParam('shipmentId');
    const shipment = sampleShipments.find(s => String(s.id) === shipmentId) || {};

    // ===== Populate Shipment Details at Top =====
    document.getElementById('spanShipmentId').textContent = shipment.id || 'N/A';
    document.getElementById('spanItem').textContent = shipment.item || 'N/A';
    document.getElementById('spanAmount').textContent = shipment.amount != null
      ? `${shipment.amount} kg`
      : 'N/A';
    document.getElementById('spanPickupTime').textContent = shipment.pickupTime
      ? new Date(shipment.pickupTime).toLocaleString()
      : 'N/A';

    // ===== Generate Container Blocks =====
    document.getElementById('btnGenerateContainers').addEventListener('click', () => {
      const count = parseInt(document.getElementById('inputContainerCount').value);
      if (isNaN(count) || count < 1) {
        alert('Enter a valid number of containers.');
        return;
      }
      createContainerBlocks(count);
    });

    function createContainerBlocks(count) {
      const containerDiv = document.getElementById('containersContainer');
      containerDiv.innerHTML = ''; // clear previous

      for (let i = 1; i <= count; i++) {
        const code = String(i).padStart(3, '0'); // e.g., "001", "002"

        const block = document.createElement('div');
        block.classList.add('container-block');
        block.id = `container-${code}`;

        // Container header
        const header = document.createElement('h3');
        header.textContent = `Container Code: `;
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.value = code;
        codeInput.readOnly = true; // would be filled by scanner in real app
        // BACKEND: Replace readOnly with scanner integration:
        // onchange="onBarcodeScanned(event, '${code}')"
        header.appendChild(codeInput);
        block.appendChild(header);

        // Item field (prefilled with shipment.item)
        const rowItem = document.createElement('div');
        rowItem.classList.add('inline-row');
        rowItem.innerHTML = `
          <label for="item-${code}">Item:</label>
          <input type="text" id="item-${code}" value="${shipment.item || ''}" />
        `;
        block.appendChild(rowItem);

        // KG field
        const rowKg = document.createElement('div');
        rowKg.classList.add('inline-row');
        rowKg.innerHTML = `
          <label for="kg-${code}">Weight (kg):</label>
          <input type="number" id="kg-${code}" placeholder="e.g. 20" />
        `;
        block.appendChild(rowKg);

        // Time Harvested
        const rowTime = document.createElement('div');
        rowTime.classList.add('inline-row');
        rowTime.innerHTML = `
          <label for="harvested-${code}">Time Harvested:</label>
          <input type="datetime-local" id="harvested-${code}" />
        `;
        block.appendChild(rowTime);

        // Quality Standards Legend
        const legendTitle = document.createElement('h4');
        legendTitle.textContent = `Quality Standards for "${shipment.item || ''}"`;
        block.appendChild(legendTitle);

        const legendTable = document.createElement('table');
        legendTable.innerHTML = `
          <thead>
            <tr>
              <th>Parameter</th>
              <th>A (≥)</th>
              <th>B (Range)</th>
              <th>C (&lt; or &gt;)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Brix (סוכר)</td>
              <td>≥ 12</td>
              <td>8–11</td>
              <td>&lt; 8</td>
            </tr>
            <tr>
              <td>Acidity (חומציות)</td>
              <td>Balanced (מאוזנת)</td>
              <td>Slight (חמוץ/תפל)</td>
              <td>Very Sour (חמוץ מאוד)</td>
            </tr>
            <tr>
              <td>Firmness (מוצקות)</td>
              <td>4–6 kg pressure</td>
              <td>2–4</td>
              <td>&lt; 2 or &gt; 6</td>
            </tr>
            <tr>
              <td>Color (צבע)</td>
              <td>Uniform, Typical</td>
              <td>Light Spots</td>
              <td>Green or Faded</td>
            </tr>
            <tr>
              <td>Weight (ק"ג)</td>
              <td>0.15–0.30</td>
              <td>0.10–0.15 or 0.30–0.35</td>
              <td>&lt; 0.10 or &gt; 0.35</td>
            </tr>
            <tr>
              <td>Size (גודל)</td>
              <td>Medium</td>
              <td>Small or Too Large</td>
              <td>Inconsistent/Abnormal</td>
            </tr>
            <tr>
              <td>Color Grade (דרגת צבע)</td>
              <td>A</td>
              <td>B</td>
              <td>C</td>
            </tr>
            <tr>
              <td>Max Defect % (אחוז פגמים)</td>
              <td>≤ 2%</td>
              <td>2%–5%</td>
              <td>&gt; 5%</td>
            </tr>
          </tbody>
        `;
        block.appendChild(legendTable);

        // Quality Parameters Dropdowns
        const paramFields = [
          'Brix', 'Acidity', 'Firmness', 'Color', 'Weight', 'Size',
          'Color Grade', 'Max Defect %'
        ];
        paramFields.forEach(param => {
          const rowParam = document.createElement('div');
          rowParam.classList.add('inline-row');
          const paramId = `${param.toLowerCase().replace(/[^a-z0-9]/g, '')}-${code}`;
          rowParam.innerHTML = `
            <label for="${paramId}">${param}:</label>
            <select id="${paramId}" class="param-select">
              <option value="" disabled selected>Choose ${param}</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          `;
          block.appendChild(rowParam);
        });

        containerDiv.appendChild(block);
      }
      // Scroll to first container
      if (count > 0) {
        document.getElementById('container-001').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // ===== Submit Shipment Report =====
    document.getElementById('btnSubmitReport').addEventListener('click', () => {
      const containerDiv = document.getElementById('containersContainer');
      const blocks = containerDiv.querySelectorAll('.container-block');
      if (blocks.length === 0) {
        alert('Generate containers first.');
        return;
      }

      const report = {
        shipmentId: shipment.id,
        containers: []
      };

      let allValid = true;

      blocks.forEach(block => {
        const code = block.querySelector('input[type="text"]').value;
        const itemVal = block.querySelector(`#item-${code}`).value.trim();
        const kgVal = parseFloat(block.querySelector(`#kg-${code}`).value);
        const timeVal = block.querySelector(`#harvested-${code}`).value;
        const params = {};
        ['brix','acidity','firmness','color','weight','size','colorgrade','maxdefect'].forEach(key => {
          const sel = block.querySelector(`#${key}-${code}`);
          params[key] = sel ? sel.value : '';
        });

        // Validate
        if (!itemVal || isNaN(kgVal) || !timeVal || Object.values(params).some(v => v === '')) {
          allValid = false;
        }

        report.containers.push({
          code,
          item: itemVal,
          weightKg: kgVal,
          harvestedTime: timeVal,
          quality: params
        });
      });

      if (!allValid) {
        alert('Please fill in all fields and parameters for each container.');
        return;
      }

      console.log('Shipment Report Data:', report);
      alert('Shipment report ready to submit. Check console.log for data.');

      // BACKEND: Replace console.log with POST to /api/shipments/{shipmentId}/report
      // fetch(`/api/shipments/${shipment.id}/report`, {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(report)
      // })
      // .then(res => {
      //   if (res.ok) {
      //     alert('Report submitted successfully.');
      //     window.location.href = 'shipments.html';
      //   } else {
      //     alert('Submission failed.');
      //   }
      // });
    });

    // ===== Logout Link =====
    document.getElementById('logoutLink4').addEventListener('click', e => {
      e.preventDefault();
      alert('Logging out... (placeholder)');
      // BACKEND: POST /api/logout → window.location.href = '/login.html';
    });
  </script>
</body>
</html>
